# Troubleshooting Common Merge Conflicts

## The "Three File Problem"

### Problem Description
You're experiencing recurring merge conflicts with the same three files that prevent successful push/pull operations. This is a common issue when working with Replit and GitHub simultaneously.

### Most Common Problem Files

1. **`.replit`** - Replit configuration file
   - Controls how your app runs in Replit
   - Modified by both Replit and manual edits
   - Contains environment and workflow settings

2. **`replit.nix`** - Nix environment specification
   - Defines packages and dependencies for Replit
   - Auto-updated by Replit when you add packages
   - Less frequently changed manually

3. **`package-lock.json`** - NPM dependency lock file
   - Auto-generated by `npm install`
   - Changes every time dependencies are updated
   - Should rarely be edited manually

## Quick Fix Guide

### Option 1: Accept Your Local Version (Replit's Version)

Use this if your Replit environment is working correctly:

```bash
# Navigate to your project
cd /path/to/Meowstik

# Keep your versions of the conflicted files
git checkout --ours .replit
git checkout --ours replit.nix

# Regenerate package-lock.json
rm package-lock.json
npm install

# Stage the resolved files
git add .replit replit.nix package-lock.json

# Complete the merge
git commit -m "Resolve merge conflicts - keep local configuration"

# Push to GitHub
git push origin main
```

### Option 2: Accept Remote Version (GitHub's Version)

Use this if you want to use what's in GitHub:

```bash
# Keep GitHub's versions
git checkout --theirs .replit
git checkout --theirs replit.nix
git checkout --theirs package-lock.json

# Stage the files
git add .replit replit.nix package-lock.json

# Complete the merge
git commit -m "Resolve merge conflicts - accept remote configuration"

# Restart your Replit to apply new configuration
# Click "Stop" then "Run"
```

### Option 3: Manual Resolution (Recommended for Understanding)

This helps you understand what's different:

```bash
# 1. Check which files are conflicted
git status

# 2. Open each conflicted file in your editor
# Look for these markers:
#   <<<<<<< HEAD (your version)
#   ======= (separator)
#   >>>>>>> branch-name (their version)

# 3. For .replit file:
#    - Keep [nix] section that works in your environment
#    - Keep [deployment] settings you prefer
#    - Merge [workflows] carefully

# 4. For replit.nix:
#    - Usually safe to keep either version
#    - If in doubt, keep yours (HEAD)

# 5. For package-lock.json:
#    - Don't try to merge manually
#    - Delete it and regenerate:
rm package-lock.json
npm install

# 6. After resolving all three files:
git add .replit replit.nix package-lock.json
git commit -m "Manually resolve merge conflicts"
git push origin main
```

## Understanding Why This Happens

### Scenario 1: Working in Both Places
- You work in Replit → changes `.replit`, `replit.nix`
- Teammate works in GitHub → changes same files
- When you try to push/pull → CONFLICT!

### Scenario 2: Replit Auto-Updates
- Replit automatically modifies `.replit` when you:
  - Install new packages
  - Change run configuration
  - Update Nix channel
- If these changes aren't in GitHub → CONFLICT!

### Scenario 3: NPM Updates
- `package-lock.json` changes when:
  - Running `npm install` with different Node versions
  - Different timing of package updates
  - Platform-specific variations
- Different versions in Replit vs GitHub → CONFLICT!

## Prevention Strategies

### Strategy 1: Single Source of Truth

**Choose one environment as primary:**

**Option A: Replit as Primary**
```bash
# Always work in Replit
# Push to GitHub regularly
git add .
git commit -m "Your changes"
git push origin main

# Pull in Replit before starting work
git pull origin main
```

**Option B: Local Development as Primary**
```bash
# Work locally, push to GitHub
git push origin main

# In Replit: Pull but don't modify config files
git pull origin main
# If Replit changes configs, discard:
git checkout .replit replit.nix
```

### Strategy 2: Ignore Lock Files (Advanced)

Add to `.gitignore` (with caution):
```
package-lock.json
```

**Pros:**
- No more package-lock.json conflicts
- Each environment uses its own lock file

**Cons:**
- Different environments might have slightly different dependencies
- Security risk if package versions aren't locked

**If you do this:**
```bash
# Remove from git
git rm --cached package-lock.json
git commit -m "Stop tracking package-lock.json"
git push origin main

# Add to .gitignore
echo "package-lock.json" >> .gitignore
git add .gitignore
git commit -m "Ignore package-lock.json"
git push origin main
```

### Strategy 3: Use Feature Branches

Never work directly on `main`:

```bash
# In Replit, create a feature branch
git checkout -b feature/my-work

# Make your changes
git add .
git commit -m "Your changes"
git push origin feature/my-work

# On GitHub, create a Pull Request
# Resolve conflicts in the PR before merging to main
# This keeps main clean
```

### Strategy 4: Replit Configuration Lock

Create a `.replitignore` file:
```
# Add files you don't want Replit to modify
```

Note: This doesn't fully prevent Replit from changing config files, but it helps.

## Step-by-Step: Breaking the Conflict Cycle

If you're stuck in a loop where the same files keep conflicting:

### Step 1: Clean Slate
```bash
# Save your work if uncommitted
git stash

# Get clean state from GitHub
git fetch origin
git reset --hard origin/main

# Check status
git status  # Should say "nothing to commit"
```

### Step 2: Apply Your Changes
```bash
# If you had stashed changes
git stash list
git stash pop

# Or manually re-apply your code changes
# (Don't touch .replit, replit.nix, or package-lock.json)
```

### Step 3: Regenerate Lock File
```bash
# Fresh package-lock.json
rm package-lock.json
npm install
```

### Step 4: Commit and Push
```bash
git add .
git commit -m "Fresh start - resolved recurring conflicts"
git push origin main
```

### Step 5: Document Configuration
Create a file called `REPLIT_CONFIG_NOTES.md`:

```markdown
# Replit Configuration

## Current Working Settings

.replit:
- Nix channel: stable-24_05
- Run command: npm run dev
- Port: 5000

replit.nix packages:
- nodejs-20
- postgresql-16
- ffmpeg
- chromium
- playwright-driver

## If conflicts occur:
Keep these values above, they're tested and working.
```

Commit this documentation:
```bash
git add REPLIT_CONFIG_NOTES.md
git commit -m "Document working Replit configuration"
git push origin main
```

## Emergency Recovery

### If You've Lost Code

```bash
# View all your recent work
git reflog

# Find the commit with your work
git log --all --oneline | grep "your description"

# Create a recovery branch
git checkout -b recovery-branch <commit-hash>

# Verify your code is there
# Then merge back:
git checkout main
git merge recovery-branch
```

### If Repository is Broken

```bash
# Clone fresh copy
cd ~/projects
git clone https://github.com/jasonbender-c3x/Meowstik.git Meowstik-fresh
cd Meowstik-fresh

# Copy your uncommitted work from broken repo
cp -r ~/old-broken-repo/specific-files ./

# Start fresh from here
git add .
git commit -m "Recovered work in fresh clone"
git push origin main
```

## Testing Your Fix

After resolving conflicts:

### 1. Verify Git Status
```bash
git status
# Should show: "nothing to commit, working tree clean"
```

### 2. Test Application
```bash
# In Replit or locally
npm install
npm run dev

# Check that app starts without errors
```

### 3. Test Push/Pull
```bash
# Try pushing
git push origin main
# Should succeed without conflicts

# Try pulling
git pull origin main
# Should say "Already up to date"
```

### 4. Verify in GitHub
- Visit your repository on GitHub
- Check that latest commit is there
- Verify files look correct

## When to Ask for Help

Ask for help if:

- Same three files conflict **after** following this guide
- You can't push or pull at all
- Error messages mention "detached HEAD" or "corrupt repository"
- You've lost important code

**Before asking, collect:**
```bash
# Run diagnostic
./scripts/check-merge-conflicts.sh

# Collect info
git status > git-status.txt
git log --oneline -10 > git-log.txt
git remote -v > git-remote.txt
git diff > git-diff.txt

# Share these files with your team or in an issue
```

## Related Documentation

- **Full Merge Guide:** `docs/MERGE_CONFLICT_RESOLUTION.md`
- **Replit Workflow:** `docs/REPLIT_GIT_WORKFLOW.md`
- **Quick Reference:** `docs/MERGE_CONFLICT_QUICK_REF.md`
- **Conflict Checker:** `./scripts/check-merge-conflicts.sh`

## Summary Checklist

When you hit the "three file problem":

- [ ] Identify which files are conflicted (`git status`)
- [ ] Decide which version to keep (yours, theirs, or manual)
- [ ] For `.replit` and `replit.nix`: Use `git checkout --ours` or `--theirs`
- [ ] For `package-lock.json`: Delete and run `npm install`
- [ ] Stage resolved files: `git add .replit replit.nix package-lock.json`
- [ ] Commit: `git commit -m "Resolve recurring conflicts"`
- [ ] Push: `git push origin main`
- [ ] Test: Run app to verify configuration works
- [ ] Document: Note what configuration you kept in team chat/docs

**Remember:** The goal is to get back to coding, not to achieve perfect merge history. Pick the version that works and move forward!
